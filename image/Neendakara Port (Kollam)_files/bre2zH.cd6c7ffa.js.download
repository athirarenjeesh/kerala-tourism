(this.$WP=this.$WP||[]).push(["bre2zH",(e,t)=>{"use strict";var a,n,r,i,o,l,c,u,s,d,m,p,g,v,f,h,k,b,_,C,E,I,S,y,R,D,T,w,x,A,P,B,F,L,N,G,M,O,V,j,q,W,z,X,H,J,U="attractionsCheckoutPopUpInfo",K=(e,t,a,n)=>{if(e){var r="string"==typeof t?t:t.originalValue||t.encodedValue&&u(t.encodedValue);if(r){var i={lastSessionId:e,popupInfo:{productCode:r,tourGradeCode:a,dismissed:n},timestamp:Date.now(),ttl:P};s.set(U,i,B)}}},Y={productCode:null,cartItemId:null,trackAction:()=>{}},Q=({pollingCall:e,completeResponsePredicate:t,pollInterval:n=1e3,maxTries:r=10,pause:i=!1})=>{var o=a.useRef(null),l=a.useRef(0),[c,u]=a.useState({fetching:!i}),[s,d]=a.useState(i);return a.useEffect((()=>{var e=c.data&&t(c.data);!s||i||e||(d(!1),u({fetching:!0}))}),[t,c.data,i,s]),a.useEffect((()=>{if(s)return()=>{};var a=()=>{if(l.current<r){l.current+=1;var i=l.current;e().then((e=>{l.current===i&&t(e)&&(u({fetching:!1,data:e}),clearTimeout(o.current))})).catch((e=>{})),o.current=setTimeout(a,n)}else u({fetching:!1})};return a(),()=>{o.current&&clearTimeout(o.current)}}),[s]),c},$=e=>e.filter((e=>e.count>0)),Z=e=>$(e).map((e=>e.bandSummaryFormatted)).join(" | "),ee=e=>new Map($(e).map((e=>[e.bandId,e.count]))),te=()=>fetch("/ShoppingCartApi/cart/detail?detailLevel=product&isCartless=true",{credentials:"same-origin"}).then((e=>{if(e.ok)return e;throw Error(JSON.stringify(e))})).then((e=>e.json())).catch((e=>({polling_state:"ERROR",result:null}))),ae=e=>e&&"IN_PROGRESS"!==e.polling_state,ne=()=>{var e,t,[n,r]=a.useState("Fetching"),[i,o]=a.useState(!1);a.useEffect((()=>{fetch("/ShoppingCartApi/cart/summary?isCartless=true",{credentials:"same-origin"}).then((e=>{if(e.ok)return e;throw Error(JSON.stringify(e))})).then((e=>e.json())).then((e=>{0===e.itemCount?r("NoItem"):o(!0)})).catch((e=>{console.error("failed fetching cart summary",e),r("Failed")}))}),[]);var l,c,u,s,m=L({pollingCall:te,completeResponsePredicate:ae,pollInterval:2e3,maxTries:5,pause:!i}),{fetching:p,data:g}=m,v=d(p),f=!p&&(null==g||null==(e=g.result)?void 0:e.cart)||null,h=(null==f||null==(t=f.items)?void 0:t[0])||null;return a.useEffect((()=>{v&&!p&&r(h?"Success":"Failed")}),[p,v,h]),{status:n,cartItem:f&&h&&(l=h,c=f,u=c.notifications.find((({cartItemId:e})=>e===l.id)),s=u&&u.notificationType||null,{...l,notificationType:s})}},re=({productCode:e,tourGradeCode:t,pax:n,travelDate:r,onAvailCheckSuccess:i,onAvailCheckFailure:o})=>{var l,c,{detailedPricingAndAvailability:u,error:s}=T(e,n.map((e=>({ageBand:p(e.bandId),count:e.count}))),r),d=null==u||null==(l=u.response)?void 0:l.tourGrades,m=d&&(c=t,d.some((e=>e&&e.available&&e.tourGradeCode===c)));return a.useEffect((()=>{d&&(m?i():o())}),[m,o,i,d]),s?null:d?a.createElement("div",null,a.createElement(D,null),a.createElement("div",null,"is ",t," available? ",a.createElement("b",null,String(m))," ")):null},ie=({productCode:e,locationId:t,tourGradeCode:n,pax:r,travelDate:i,onAvailCheckSuccess:o,onAvailCheckFailure:l})=>{var{localize:c}=I(),u=S();return a.useEffect((()=>{g(e,n,i,ee(r),null,t||0,c,u).then((e=>{((e,t)=>t.some((t=>t.available&&t.gradeCode===e)))(n,e)&&o()})).catch((e=>{l()}))}),[t,l,o,r,e,n,i,c,u]),null},oe=e=>{var{onAvailCheckSuccess:t,onAvailCheckFailure:n}=e,[r,o]=a.useState(!0),l=i("attractions_checkout_abandonment_pop_up_apds_check_availability"),c=a.useCallback((()=>{o(!1)}),[]),u=a.useCallback((()=>{c(),t()}),[c,t]),s=a.useCallback((()=>{c(),n()}),[c,n]),d={...e,onAvailCheckSuccess:u,onAvailCheckFailure:s};return a.createElement(a.Fragment,null,r&&a.createElement(D,null),l&&a.createElement(G,d),!l&&a.createElement(M,d))},le={width:360,height:240},ce=e=>null!=e&&e.length>0,ue=({title:e,url:t,imageUrl:n,departureTime:r,formattedPax:i,price:l,cancellationMessage:c,numReviews:u,bubbleRating:s})=>{var{viewportCategory:d}=a.useContext(o),{trackAction:m}=a.useContext(F);return a.useEffect((()=>{m("impression_lightbox")}),[m]),a.createElement("div",{className:"dZygo A Fi"},a.createElement("div",{className:"fAzLc w"},a.createElement(A,{theme:"image",href:t,target:"_blank",onClick:()=>m("click_photo")},a.createElement(x,{source:[{...le,url:n||""}],alt:e,width:"100%",aspectRatio:"MOBILE"===d?"auto":"1:1"}))),a.createElement("div",{className:"cAavS A"},a.createElement(A,{theme:"standalone",href:t,target:"_blank",onClick:()=>m("click_title")},a.createElement(R,{variant:"title-04"},e)),null!=u&&null!=s&&(u>0||s>0)&&a.createElement(w,{numReviews:u,rating:s,size:"small"}),ce(r)&&a.createElement(R,{variant:"supporting-01"},r),ce(i)&&a.createElement(R,{variant:"supporting-01"},i),ce(c)&&a.createElement(R,{variant:"supporting-01"},c),a.createElement(R,{variant:"supporting-03"},l)))};function se(...e){for(var t=[],a=function(a){var n=e[a];if(n){var r=typeof n;"string"===r||"number"===r?t.push(n):Array.isArray(n)?t.push(se(...n)):"object"===r&&Object.keys(n).filter((e=>n[e])).forEach((e=>t.push(e)))}},n=0;n<e.length;n++)a(n);return t.join(" ")}var de={marginLeft1:"dBhKd",marginRight1:"cCzei",marginTop1:"cbSHg",marginBottom1:"eVjae",marginLeft2:"bGusc",marginRight2:"fksET",marginTop2:"bLFSo",marginBottom2:"cspKb",marginLeft3:"edkls",marginRight3:"eQkGL",marginTop3:"RiTin",marginBottom3:"MLeMj",marginLeft4:"bjDAD",marginRight4:"eyRbR",marginTop4:"faMvo",marginBottom4:"fbrwK",marginLeft5:"cxGsy",marginRight5:"cOCVE",marginTop5:"fBRVc",marginBottom5:"eXrsm",marginLeft6:"daVLy",marginRight6:"cSWgH",marginTop6:"eufYP",marginBottom6:"cDHZq",marginLeft7:"eRgrC",marginRight7:"dahXR",marginTop7:"FMwqw",marginBottom7:"eXqEW",marginLeft8:"civSC",marginRight8:"frWqN",marginTop8:"cAQlX",marginBottom8:"chJfh",marginLeft9:"frDlr",marginRight9:"bTXxI",marginTop9:"dthya",marginBottom9:"bwqlk",marginLeft10:"OOOCl",marginRight10:"LWpUV",marginTop10:"fyHai",marginBottom10:"bSjHJ"};function me(e){for(var t={},a=1;a<=10;a++)t[`spacing-${String(a).padStart(2,"0")}`]=de[`margin${e}${a}`];return t}function pe({margin:e,marginX:t,marginY:a,marginTop:n,marginBottom:r,marginLeft:i,marginRight:o}){var l=n||a||e,c=r||a||e,u=i||t||e,s=o||t||e;return se(l&&j.top[l],c&&j.bottom[c],u&&j.left[u],s&&j.right[s])}var ge=e=>n.createElement("svg",(({color:e="inherit",size:t="inherit",...a},r=!1)=>{var i="inherit"!==t?`${t}px`:"1em",{isRtl:o}=n.useContext(l).locale;return{viewBox:"0 0 24 24",width:i,height:i,className:se("bDFSd d Vb",pe(a),"inherit"===e&&"ymbyq","primaryIcon"===e&&"XHxQa","secondaryIcon"===e&&"dZxVn","onDarkIcon"===e&&"dRJTS","primarySelectedIcon"===e&&"CYIDi","activeMapPinIcon"===e&&"cFxQv","bubbleIcon"===e&&"dWmWj","starIconFilled"===e&&"sFBYx","starIconEmpty"===e&&"Stndk","dragIcon"===e&&"eSOtO","dangerIcon"===e&&"frovT","verifiedCheckMarkIcon"===e&&"coqqe","accentPurpleText"===e&&"cYGZX","onLightText"===e&&"bVlNw","plusIcon"===e&&"ehGNF","textDisabled"===e&&"dasoo",!r&&o&&"eeDcX")}})(e),n.createElement("path",{d:"M20.3 3.675c0-.2-.2-.4-.5-.5l-7-.6c-.1 0-.3 0-.4.1l-10.1 10.1c-.2.2-.2.5 0 .7l7.8 7.8c.2.2.5.2.7 0l10.1-10.1c.1-.1.1-.2.1-.4l-.7-7.1zm-9.9 15.1l-5.7-5.7 8.5-8.5 5.2.5.5 5.2-8.5 8.5z"}),n.createElement("path",{d:"M16 6.575c-.3 0-.5.1-.7.3-.2.2-.3.5-.3.7 0 .6.4 1 1 1 .3 0 .5-.1.7-.3.2-.2.3-.4.3-.7 0-.5-.5-1-1-1z"})),ve=()=>{var[e,t]=a.useState(!1);return a.createElement(a.Fragment,null,a.createElement("div",{className:"fqwsR"},a.createElement(q,{color:"dangerIcon",size:20}),a.createElement(y,{id:"attractions_checkout_abandonment_popup_special_offer_title_unescaped",args:{specialOfferClass:"bJwDK b",promoCode:"SAVETODAY",promoCodeClass:"kDXDp b"}})," ",a.createElement("span",{className:"bMLlS _S",onClick:()=>t((e=>!e))},a.createElement(E,{id:"attractions_checkout_abandonment_popup_special_offer_see_terms"})),"."),e&&a.createElement("div",{className:"fwoim Pa PQ Pn PD"},a.createElement(E,{id:"attractions_checkout_abandonment_popup_special_offer_terms_feb_2020"})))},fe=({productId:e,productCode:t,tourGradeCode:n,pax:r,travelDate:l,travelDateUI:u,displayedPrice:d,productDisplay:p,cancellationMessage:g,isAvailable:f,bubbleRating:y,numReviews:D})=>{var T,{localize:w}=I(),x=S(),{trackAction:A}=a.useContext(F),{sessionId:P}=a.useContext(c),B="MOBILE"===a.useContext(o).viewportCategory,[L,N]=a.useState(!1),[G,M]=a.useState(!1),[j]=h({query:X,variables:{productId:e},requestPolicy:"network-only"}),{fetching:q,data:z}=j,H=null==z||null==(T=z.attractionProducts)?void 0:T[0],J=null==H?void 0:H.url;a.useEffect((()=>{var e,a,r;!q&&z&&N((e={productCode:t,tourGradeCode:n},!(r=(a=s.get(U))&&a.popupInfo)||r.productCode!==e.productCode||r.tourGradeCode!==e.tourGradeCode||!r.dismissed))}),[z,q,t,n]);var Y=a.useCallback((()=>{setTimeout((()=>{window.location="/shoppingCartCheckout?isCartless=true"}),300)}),[]),Q=a.useCallback((()=>{null!=J&&J.length>0&&(k(t,r.map((({bandId:e,count:t})=>({bandId:e,count:t}))),v(l),((e,t,a,n)=>m(e,ee(t),a,n))(l,r,w,x)),window.location=J)}),[J,r,t,l,w,x]),$=a.useCallback((e=>{K(P,t,n,e)}),[t,n,P]),te=a.useCallback((()=>{A("click_exit"),N(!1),$(!0)}),[$,A]),ae=b((()=>{$(!1)})),{name:ne,url:re,imageUrl:ie,activityId:oe}=H||{};if(null==ne||!ne||null==re||!re)return null;var le,ce=a.createElement(E,{id:"attractions_checkout_abandonment_popup_header"}),ue=a.createElement(_,{onClick:()=>{A("click_continue_checkout"),M(!0)},fullWidth:B,disabled:!f},a.createElement(E,{id:"attractions_checkout_abandonment_popup_continue_checkout"})),se=a.createElement(_,{variant:"secondary",href:re,target:"_blank",onClick:()=>{A("click_view_details"),$(!0)},fullWidth:B},a.createElement(E,{id:"attractions_checkout_abandonment_popup_view_details"}));return L&&!!ne&&!!re&&a.createElement(C,{title:ce,primaryButton:ue,secondaryButton:se,onClose:te,buttonsAlignment:"left",buttonStyle:B?"stacked":void 0},a.createElement("div",{ref:ae},i("attractions_checkout_abandonment_pop_up_with_promo")&&a.createElement(W,null),a.createElement(V,{title:ne,url:re,imageUrl:ie,departureTime:(le=[p.gradeDepartureTime,u],le.filter(Boolean).join(" • ")),formattedPax:Z(p.passengerMix),price:d,cancellationMessage:g,bubbleRating:y,numReviews:D}),G&&a.createElement(O,{productCode:t,locationId:oe,tourGradeCode:n,pax:r,travelDate:l,onAvailCheckSuccess:Y,onAvailCheckFailure:Q}),a.createElement(R,{variant:"supporting-02",marginTop:"spacing-04"},a.createElement(E,{id:"attractions_checkout_abandonment_popup_avail_and_price_change"}))))},he=()=>{var e=f(),{status:t,cartItem:n}=N(),r=d(t),[i,o]=a.useState(Y);if(a.useEffect((()=>{if("Fetching"===r&&"Success"===t&&n){var{productCode:a}=n.productParameters,i=n.id;o({productCode:a,cartItemId:i,trackAction:t=>{e({module:"checkout_abandonment_box",action:t,context:[a,i,String(!1)].join(" | ")})}})}}),[n,r,e,t]),!n)return null;var l=n.productParameters,{productId:c,productCode:u,tourGradeCode:s,checkinDate:m,checkinDateUI:p,cancellationCondition:g,bookingProduct:h}=l,k=n.display,{passengerMix:b}=k,_=n.availability.priceFormatted;return a.createElement(F.Provider,{value:i},"PAST_CHECKIN_DATE"!==n.notificationType&&v(m)>=new Date&&a.createElement(H,{productId:c,productCode:u,tourGradeCode:s,pax:b,travelDate:m,travelDateUI:p,displayedPrice:_,cancellationMessage:g,productDisplay:k,isAvailable:!n.notificationType,bubbleRating:null==h?void 0:h.rating,numReviews:null==h?void 0:h.num_reviews}))},ke=()=>{var[e,t]=a.useState(!1),{sessionId:n}=a.useContext(c),o=i("attractions_checkout_abandonment_pop_up_with_promo")||i("attractions_checkout_abandonment_pop_up");return a.useEffect((()=>{(e=>{var t=s.get(U);return!t||t.lastSessionId!==e||Date.now()>t.timestamp+t.ttl})(n)&&t(o)}),[o,n]),e&&a.createElement(r,null,a.createElement(J,null))};return[()=>{P=72e5,B=2592e6,F=a.createContext(Y),L=Q,N=ne,G=re,M=ie,O=oe,V=ue,j={top:me("Top"),bottom:me("Bottom"),left:me("Left"),right:me("Right")},q=ge,W=ve,(z=JSON.parse('{"kind":"Document","definitions":[{"kind":"OperationDefinition","operation":"query","name":{"kind":"Name","value":"CartItemAttractionProductInfo"},"variableDefinitions":[{"kind":"VariableDefinition","variable":{"kind":"Variable","name":{"kind":"Name","value":"productId"}},"type":{"kind":"NonNullType","type":{"kind":"NamedType","name":{"kind":"Name","value":"Int"}}},"directives":[]}],"directives":[],"selectionSet":{"kind":"SelectionSet","selections":[{"kind":"Field","name":{"kind":"Name","value":"attractionProducts"},"arguments":[{"kind":"Argument","name":{"kind":"Name","value":"attractionProductIds"},"value":{"kind":"ListValue","values":[{"kind":"Variable","name":{"kind":"Name","value":"productId"}}]}}],"directives":[],"selectionSet":{"kind":"SelectionSet","selections":[{"kind":"Field","name":{"kind":"Name","value":"name"},"arguments":[],"directives":[]},{"kind":"Field","name":{"kind":"Name","value":"imageUrl"},"arguments":[],"directives":[]},{"kind":"Field","name":{"kind":"Name","value":"url"},"arguments":[],"directives":[]},{"kind":"Field","name":{"kind":"Name","value":"activityId"},"arguments":[],"directives":[]}]}}]}}],"loc":{"start":0,"end":174}}')).__key=0xcc3723961415,X=z,H=fe,J=he,e({default:ke,setPopupInfo:K})},[e=>(a=e,n=e.default),e=>r=e.RobotSafeClientOnly,e=>i=e.featureIsEnabled,e=>(o=e.Device,l=e.Environment,c=e.Visitor),e=>u=e.default,e=>s=e.default,e=>d=e.default,e=>(m=e.soldOutMessageGated,p=e.ageBandInputFrom,g=e.getTourGrades,v=e.getLocalDateFromString),e=>f=e.useGARecorder,e=>h=e.useQuery,e=>k=e.writeMessage,e=>b=e.useOnVisible,e=>_=e.default,e=>C=e.Modal,e=>(E=e.default,I=e.useLocalize,S=e.useIntlFormatter,y=e.UnsafeLocalize),e=>R=e.default,e=>D=e.LoadingSpinner,e=>T=e.useDetailedPricingAndAvailability,e=>w=e.BubbleRatingWithReviewCount,e=>x=e.default,e=>A=e.default]]},["cDcdfi","4Z07E2","-i3PJS","2R4xv2","dROhDJ","jaCyxS","vWxBAe","4fTSbk","fsml46","5X2em-","EYH0wr","BLrxBS","7yGKf-","E1X9WP","0DsHEV","VP50Wc","V08PS7","hg9k0-","MBK0so","BgJkqv","5KqyYa"]]);
