(this.$WP=this.$WP||[]).push(["4fTSbk",(r,t)=>{"use strict";var e,a,i,o,n,s,l=1e3,_=(r,t,e,a,i,o,n,s,_)=>new Promise(((g,c)=>{var d,u,p={geoId:r,attractionId:t,partnerName:n,productCode:e,tourGradeCode:a,tourDate:i,passengerMix:(d=o,u={},d.forEach(((r,t)=>{u[t]=r})),u)},m=r=>{fetch(s?"/ShoppingCartApi/cart/add?isCartless=true":"/ShoppingCartApi/cart/add",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p),credentials:"same-origin"}).then((r=>{if(r.ok)return r;throw Error(r.statusText)})).then((r=>r.json())).then((t=>{if("COMPLETE"!==t.polling_state)"IN_PROGRESS"===t.polling_state&&r<30?setTimeout((()=>m(r+1)),l):c(Error(_.string("attractions.booking.errors.api_error")));else if(t.result)switch(t.result.status){case"SUCCESS":g(t.result);break;case"DUPLICATE_ITEM":c(Error(_.string("attractions.cart.item_already_added_with_link",{0:"/ShoppingCart"})));break;case"ITEM_NOT_AVAILABLE":c(Error(_.string("attractions.cart.alert_not_available")));break;default:c(Error(_.string("attractions.booking.errors.api_error")))}})).catch((()=>{c(Error(_.string("attractions.booking.errors.api_error")))}))};m(1)}));function g(r,t,e){return new Promise(((a,i)=>{var o=n=>{fetch(`/AttractionBookingApi/product/${t?`${t}/`:""}${r}/dates`,{credentials:"same-origin"}).then((r=>{if(r.ok)return r;throw Error(r.statusText)})).then((r=>r.json())).then((r=>{"COMPLETE"!==r.polling_state?"IN_PROGRESS"===r.polling_state&&n<30?setTimeout((()=>o(n+1)),l):i(Error(e.string("attractions.booking.errors.api_error"))):a(r.data)})).catch((()=>{i(Error(e.string("attractions.booking.errors.api_error")))}))};o(1)}))}var c=r=>{switch(r){case 1:return"ADULT";case 2:return"CHILD";case 3:return"INFANT";case 4:return"YOUTH";case 5:return"SENIOR";default:return"ADULT"}},d=(r,t)=>{var e,a=1===r.size;return 1===(e=Array.from(r,(r=>((r,t,e,a)=>{if(e)return a.string("attractions.booking.common_n_traveler",{0:t});if(t<1)return"";switch(r){case 1:return a.string("attractions.booking.common_n_adult",{0:t});case 2:return a.string("attractions.booking.common_n_child",{0:t});case 3:return a.string("attractions.booking.common_n_infant",{0:t});case 4:return a.string("attractions.booking.common_n_youth",{0:t});case 5:return a.string("attractions.booking.common_n_senior",{0:t});default:return""}})(r[0],r[1],a,t))).filter((r=>""!==r))).length?e[0]:e.join(", ")},u="DEFAULT",p=r=>{var[t,e,a]=r.split("-").map((r=>parseInt(r,10)));return new Date(t,e-1,a)},m=(r,t,e,a)=>((r,t,e,a)=>{var i=a.formatDate("week_date_long",r),o=d(t,e);return e.string("attractions.booking.tour_grade_unavailable_for_pax_date",{PAX:o,date:i})})(p(r),t,e,a),b=(r,t,a,i)=>e("attractions_apd_sold_out_message_with_additional_availability")?m(r,t,a,i):a.string("attractions.booking.tour_grade_unavailable_try_different");function E(r,t,a,i,o,n,s,_,g,c,d){var p=m(a,i,s,_),b=e("attractions_apd_sold_out_message_with_additional_availability");return new Promise(((e,_)=>{var m=new URLSearchParams;m.append("tourDate",a),m.append("attrdate",(r=>r.replace(/-/g,"_"))(a)),m.append("ageBands",Array.from(i).map((r=>`${r[0]}:${r[1]}`)).join(",")),g&&m.append("languageServices",g),m.append("locationId",JSON.stringify(n));var E=`/AttractionBookingApi/product/${o?`${o}/`:""}${r}/tour_grades?${m.toString()}`,h=r=>{fetch(E,{credentials:"same-origin"}).then((r=>{if(r.ok)return r;throw Error(r.statusText)})).then((r=>r.json())).then((a=>{if("COMPLETE"===a.polling_state){c&&c();try{var i=a.tour_grades.map((r=>({gradeCode:r.grade_code,sortOrder:r.sort_order,rnplEligibility:{eligible:!!r.rnpl_eligibility&&r.rnpl_eligibility.eligible,ineligibilityReasons:r.rnpl_eligibility?r.rnpl_eligibility.ineligibility_reasons:[]},gradeTitle:u===r.grade_title?t:r.grade_title,gradeDescription:u===r.grade_title?"":r.grade_description,priceFormatted:r.price_formatted,maxTravelersPerUnit:r.max_travelers_per_unit,ageBandsDisplay:r.age_bands.map((r=>r.band_summary)),available:r.available,isMostPopularText:r.is_most_popular_text,langServices:null!==r.lang_services?Object.keys(r.lang_services):null})));i.some((r=>r.available))||(d&&d(),_(b?Error(p):Error(s.string("attractions.booking.tour_grade_unavailable_try_different")))),e(i)}catch(r){_(Error(s.string("attractions.booking.errors.api_error")))}}else"IN_PROGRESS"===a.polling_state&&r<30?setTimeout((()=>h(r+1)),l):(d&&d(),b&&"NO_LONGER_AVAILABLE"===a.polling_state?_(Error(p)):_(Error(a.error_messages[0])))})).catch((()=>{_(Error(s.string("attractions.booking.errors.api_error")))}))};h(1)}))}var h=r=>i.createElement(o,{id:"exp_see_n_experiences_cap",args:{0:r.productCount}});function f(r){var{localize:t}=n(),e=s();return function(i){return a.createElement(r,Object.assign({},i,{localize:t,intlFormatter:e}))}}return r({getAvailableDates:g,getTourGrades:E,withLocalize:f}),[()=>{r({MAX_PAX_COUNT:15,POLLING_MAX_TRIES:30,POLLING_TIME_OUT:l,addToCart:_,ageBandInputFrom:c,getAvailableDates:g,getCTAKey:h,getLocalDateFromString:p,getPAXText:d,getTourGrades:E,soldOutMessageGated:b,withLocalize:f})},[r=>e=r.featureIsEnabled,r=>(a=r,i=r.default),r=>(o=r.default,n=r.useLocalize,s=r.useIntlFormatter)]]},["-i3PJS","cDcdfi","0DsHEV"]]);
